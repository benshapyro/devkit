---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { parseArtifactId } from '../../content.config';

export const prerender = true;

export async function getStaticPaths() {
  const hooks = await getCollection('hooks');
  return hooks.map(hook => {
    const { slug } = parseArtifactId(hook.id);
    return {
      params: { slug },
      props: { hook },
    };
  });
}

const { hook } = Astro.props;
const { Content, headings } = await render(hook);
const { slug } = parseArtifactId(hook.id);

// Parse hook name from body
function parseHookName(body: string) {
  const lines = body.split('\n');
  for (const line of lines) {
    if (line.startsWith('# ')) {
      return line.replace(/^#\s+/, '').trim();
    }
  }
  return slug;
}

const hookName = parseHookName(hook.body || '');

// Parse description from body (first paragraph after H1)
function parseHookDescription(body: string) {
  const lines = body.split('\n');
  let foundH1 = false;
  for (const line of lines) {
    if (line.startsWith('# ')) {
      foundH1 = true;
      continue;
    }
    if (foundH1 && line.trim() && !line.startsWith('#')) {
      return line.trim();
    }
  }
  return '';
}

const hookDescription = parseHookDescription(hook.body || '');

const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<Layout
  title={`${hookName} | Devkit`}
  description={hookDescription}
>
  <head slot="head">
    <meta property="og:type" content="article" />
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TechArticle",
      "headline": hookName,
      "description": hookDescription,
      "url": canonicalURL.href,
    })} />
  </head>

  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4
           focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-zinc-900
           focus:rounded focus:outline-none"
  >
    Skip to main content
  </a>

  <main id="main-content" class="min-h-screen">
    <div class="max-w-6xl mx-auto px-6 py-12">
      <nav class="mb-8">
        <a
          href={`${baseUrl}/hooks`}
          class="inline-flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors group"
        >
          <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Hooks
        </a>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-12">
        <div>
          <header class="relative overflow-hidden bg-gradient-to-br from-zinc-900 to-zinc-950 border border-zinc-800/60 rounded-2xl p-8 mb-10">
            {/* Subtle dot pattern */}
            <div
              class="absolute inset-0 opacity-[0.015]"
              style="background-image: radial-gradient(circle at 1px 1px, white 1px, transparent 0); background-size: 24px 24px;"
            />

            {/* Glow effect */}
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-amber-500/10 rounded-full blur-3xl pointer-events-none" />

            <div class="relative">
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20">
                  {hook.data.event}
                </span>
                {hook.data.matcher && (
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-mono bg-zinc-800/50 text-zinc-400 border border-zinc-700/50">
                    matcher: {hook.data.matcher}
                  </span>
                )}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-zinc-800/50 text-zinc-400 border border-zinc-700/50">
                  {hook.data.type}
                </span>
              </div>

              <h1 id="article-title" class="text-4xl md:text-5xl font-bold tracking-tight text-white">
                {hookName}
              </h1>

              {hookDescription && (
                <p class="text-zinc-400 mt-4 text-lg leading-relaxed max-w-2xl">
                  {hookDescription}
                </p>
              )}
            </div>
          </header>

          <article
            class="prose prose-zinc prose-invert max-w-none
                   prose-headings:text-white
                   prose-a:text-amber-400 prose-a:no-underline hover:prose-a:underline
                   prose-code:text-amber-300 prose-code:bg-zinc-800 prose-code:px-1 prose-code:rounded
                   prose-pre:bg-zinc-900 prose-pre:border prose-pre:border-zinc-800"
            aria-labelledby="article-title"
          >
            <Content />
          </article>
        </div>

        {tocHeadings.length >= 3 && (
          <aside class="hidden lg:block">
            <nav aria-label="Table of contents" class="sticky top-24 p-4 bg-zinc-900/30 backdrop-blur rounded-xl border border-zinc-800/50">
              <h2 class="text-xs font-semibold text-zinc-500 uppercase tracking-wide mb-3">
                On this page
              </h2>
              <ul class="space-y-2">
                {tocHeadings.map(({ depth, slug, text }) => (
                  <li style={`padding-left: ${(depth - 2) * 0.75}rem`}>
                    <a
                      href={`#${slug}`}
                      class="text-sm text-zinc-400 hover:text-white transition-colors block py-1"
                    >
                      {text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          </aside>
        )}
      </div>
    </div>
  </main>
</Layout>

<script>
  // Check for clipboard API support before adding copy buttons
  if (!navigator.clipboard) {
    // Clipboard API not supported - skip copy button functionality
  } else {
    document.querySelectorAll('pre').forEach(pre => {
      pre.classList.add('group', 'relative');

      const code = pre.querySelector('code');
      if (!code) return;

      const button = document.createElement('button');
      button.className = 'copy-button absolute top-3 right-3 p-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition-all opacity-0 group-hover:opacity-100';
      button.setAttribute('aria-label', 'Copy code');
      button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;

      button.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(code.textContent || '');
          button.setAttribute('aria-label', 'Copied!');
          button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;

          setTimeout(() => {
            button.setAttribute('aria-label', 'Copy code');
            button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      pre.appendChild(button);
    });
  }
</script>
