---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { parseSkillId } from '../../content.config';
import { hasDownload } from '../../lib/downloads';
import { DownloadButton } from '../../components/DownloadButton';
import { CopyInstallButton } from '../../components/CopyInstallButton';

export const prerender = true;

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  return skills.map(skill => {
    const { slug } = parseSkillId(skill.id);
    return {
      params: { slug },
      props: { skill },
    };
  });
}

const { skill } = Astro.props;
const { Content, headings } = await render(skill);
const { group, slug } = parseSkillId(skill.id);

const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<Layout
  title={`${skill.data.name} | Devkit`}
  description={skill.data.description}
>
  <head slot="head">
    <meta property="og:type" content="article" />
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TechArticle",
      "headline": skill.data.name,
      "description": skill.data.description,
      "url": canonicalURL.href,
    })} />
  </head>

  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4
           focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-zinc-900
           focus:rounded focus:outline-none"
  >
    Skip to main content
  </a>

  <main id="main-content" class="min-h-screen">
    <div class="max-w-6xl mx-auto px-6 py-12">
      <nav class="mb-8">
        <a
          href={baseUrl || '/'}
          class="inline-flex items-center gap-2 text-sm text-[#6E7191] hover:text-[#0C0407] transition-colors group"
        >
          <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Gallery
        </a>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-12">
        <div>
          <header class="relative overflow-hidden bg-gradient-to-br from-[#F2EFE4] to-white border border-[#E5E2D8] rounded-2xl p-8 mb-10">
            {/* Subtle dot pattern */}
            <div
              class="absolute inset-0 opacity-[0.015]"
              style="background-image: radial-gradient(circle at 1px 1px, white 1px, transparent 0); background-size: 24px 24px;"
            />

            {/* Glow effect */}
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-[#DB4545]/10 rounded-full blur-3xl pointer-events-none" />

            <div class="relative">
              <div class="flex items-center gap-3 mb-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-[#DB4545]/10 text-[#DB4545] border border-[#DB4545]/20">
                  {group}
                </span>
              </div>

              <h1 id="article-title" class="text-4xl md:text-5xl font-bold tracking-tight text-[#0C0407]">
                {skill.data.name}
              </h1>

              <p class="text-[#6E7191] mt-4 text-lg leading-relaxed max-w-2xl">
                {skill.data.description}
              </p>

              <div class="flex items-center gap-3 mt-6">
                {hasDownload(slug) && (
                  <DownloadButton slug={slug} baseUrl={baseUrl} variant="full" />
                )}
                <CopyInstallButton client:load skillPath={`${group}/${slug}`} />
              </div>
            </div>
          </header>

          <article
            class="prose prose-zinc max-w-none
                   prose-headings:text-[#0C0407]
                   prose-a:text-[#DB4545] prose-a:no-underline hover:prose-a:underline
                   prose-code:text-[#DB4545] prose-code:bg-[#F2EFE4] prose-code:px-1 prose-code:rounded
                   prose-pre:bg-[#F2EFE4] prose-pre:border prose-pre:border-[#E5E2D8]"
            aria-labelledby="article-title"
          >
            <Content />
          </article>
        </div>

        {tocHeadings.length >= 3 && (
          <aside class="hidden lg:block">
            <nav aria-label="Table of contents" class="sticky top-24 p-4 bg-[#F2EFE4]/50 backdrop-blur rounded-xl border border-[#E5E2D8]">
              <h2 class="text-xs font-semibold text-[#6E7191] uppercase tracking-wide mb-3">
                On this page
              </h2>
              <ul class="space-y-2">
                {tocHeadings.map(({ depth, slug, text }) => (
                  <li style={`padding-left: ${(depth - 2) * 0.75}rem`}>
                    <a
                      href={`#${slug}`}
                      class="text-sm text-[#6E7191] hover:text-[#0C0407] transition-colors block py-1"
                    >
                      {text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          </aside>
        )}
      </div>
    </div>
  </main>
</Layout>

<script>
  // Check for clipboard API support before adding copy buttons
  if (!navigator.clipboard) {
    // Clipboard API not supported - skip copy button functionality
  } else {
    document.querySelectorAll('pre').forEach(pre => {
      pre.classList.add('group', 'relative');

      const code = pre.querySelector('code');
      if (!code) return;

      const button = document.createElement('button');
      button.className = 'copy-button absolute top-3 right-3 p-2 rounded-lg bg-[#E5E2D8] hover:bg-[#D8D4C7] text-[#6E7191] hover:text-[#0C0407] transition-all opacity-0 group-hover:opacity-100';
      button.setAttribute('aria-label', 'Copy code');
      button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;

      button.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(code.textContent || '');
          button.setAttribute('aria-label', 'Copied!');
          button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;

          setTimeout(() => {
            button.setAttribute('aria-label', 'Copy code');
            button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      pre.appendChild(button);
    });
  }
</script>
